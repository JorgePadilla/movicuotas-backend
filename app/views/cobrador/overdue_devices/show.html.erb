<% content_for :title, "Detalle del Dispositivo - MOVICUOTAS" %>

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-[#125282]">Detalle del Dispositivo en Mora</h1>
    <div class="flex gap-2">
      <%= link_to "‚Üê Volver a Lista", cobrador_overdue_devices_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
    </div>
  </div>

  <!-- Device Information Card -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Informaci√≥n del Dispositivo</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-sm text-gray-500">IMEI</p>
        <p class="text-lg font-mono font-semibold text-gray-900"><%= @device_details[:device][:imei] %></p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Marca</p>
        <p class="text-lg font-semibold text-gray-900"><%= @device_details[:device][:brand] %></p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Modelo</p>
        <p class="text-lg font-semibold text-gray-900"><%= @device_details[:device][:model] %></p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Estado de Bloqueo</p>
        <p class="text-lg font-semibold">
          <% case @device_details[:device][:lock_status] %>
          <% when "locked" %>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">üî¥ Bloqueado</span>
          <% when "pending" %>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">üü° Pendiente</span>
          <% else %>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">üü¢ Desbloqueado</span>
          <% end %>
        </p>
      </div>
    </div>
    <% if @device_details[:device][:locked_at].present? %>
      <div class="mt-4 pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-500">Fecha de Bloqueo</p>
        <p class="text-sm text-gray-900"><%= l @device_details[:device][:locked_at], format: :long %></p>
      </div>
    <% end %>
  </div>

  <!-- Customer Information Card -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Informaci√≥n del Cliente</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-sm text-gray-500">Nombre</p>
        <p class="text-lg font-semibold text-gray-900"><%= @device_details[:customer][:name] %></p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Tel√©fono</p>
        <p class="text-lg font-semibold text-gray-900"><%= @device_details[:customer][:phone] %></p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Identificaci√≥n</p>
        <p class="text-lg font-semibold text-gray-900"><%= @device_details[:customer][:identification] %></p>
      </div>
    </div>
  </div>

  <!-- Loan Information Card -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Informaci√≥n del Pr√©stamo</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-sm text-gray-500">N√∫mero de Contrato</p>
        <p class="text-lg font-semibold text-gray-900"><%= @device_details[:loan][:contract_number] %></p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Estado del Pr√©stamo</p>
        <p class="text-lg font-semibold text-gray-900">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
            <%= @device_details[:loan][:status] %>
          </span>
        </p>
      </div>
    </div>
  </div>

  <!-- Overdue Information Card -->
  <div class="bg-white shadow rounded-lg p-6 mb-6 border-l-4 border-red-500">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Informaci√≥n de Mora</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div>
        <p class="text-sm text-gray-500">Total en Mora (RD$)</p>
        <p class="text-3xl font-bold text-red-600">
          RD$ <%= number_with_precision(@device_details[:overdue][:total_overdue], precision: 2) %>
        </p>
      </div>
      <div>
        <p class="text-sm text-gray-500">D√≠as de Atraso</p>
        <p class="text-3xl font-bold text-red-600"><%= @device_details[:overdue][:days_since_first] %> d√≠as</p>
      </div>
      <div>
        <p class="text-sm text-gray-500">Cuotas Vencidas</p>
        <p class="text-3xl font-bold text-red-600"><%= @device_details[:overdue][:installments]&.count || 0 %></p>
      </div>
    </div>

    <!-- Overdue Installments Table -->
    <% if @device_details[:overdue][:installments].present? %>
      <div class="mt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Cuotas Vencidas</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cuota</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha de Vencimiento</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monto (RD$)</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">D√≠as de Atraso</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @device_details[:overdue][:installments].each do |installment| %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-900">#<%= installment.installment_number %></td>
                  <td class="px-4 py-2 text-sm text-gray-600"><%= l installment.due_date, format: :short %></td>
                  <td class="px-4 py-2 text-sm font-semibold text-red-600">
                    RD$ <%= number_with_precision(installment.amount, precision: 2) %>
                  </td>
                  <td class="px-4 py-2 text-sm text-red-600 font-semibold"><%= installment.days_overdue %> d√≠as</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Upcoming Payments Card -->
  <% if @device_details[:upcoming].present? %>
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Pr√≥ximas Cuotas</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cuota</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha de Vencimiento</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monto (RD$)</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @device_details[:upcoming].each do |installment| %>
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900">#<%= installment.installment_number %></td>
                <td class="px-4 py-2 text-sm text-gray-600"><%= l installment.due_date, format: :short %></td>
                <td class="px-4 py-2 text-sm font-semibold text-gray-900">
                  RD$ <%= number_with_precision(installment.amount, precision: 2) %>
                </td>
                <td class="px-4 py-2 text-sm">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    Pendiente
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Block Device Action Card -->
  <% if @device.unlocked? %>
    <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6">
      <h2 class="text-lg font-semibold text-red-900 mb-4">Acciones de Cobrador</h2>
      <p class="text-red-700 mb-4">
        Este dispositivo est√° desbloqueado y puede ser bloqueado a trav√©s del sistema MDM.
      </p>
      <%= link_to "üî¥ Bloquear Dispositivo",
                  cobrador_overdue_device_block_path(@device),
                  class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700" %>
    </div>
  <% elsif @device.pending? %>
    <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-6">
      <h2 class="text-lg font-semibold text-yellow-900 mb-4">Estado del Bloqueo</h2>
      <p class="text-yellow-700">
        Este dispositivo est√° en proceso de bloqueo y est√° esperando confirmaci√≥n del sistema MDM.
      </p>
    </div>
  <% else %>
    <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6">
      <h2 class="text-lg font-semibold text-green-900 mb-4">Dispositivo Bloqueado</h2>
      <p class="text-green-700">
        Este dispositivo est√° actualmente bloqueado a trav√©s del sistema MDM. Solo los administradores pueden desbloquearlo.
      </p>
    </div>
  <% end %>
</div>
