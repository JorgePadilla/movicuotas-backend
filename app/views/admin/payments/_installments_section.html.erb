<% if installments.present? %>
  <% total_pending = installments.sum(&:remaining_amount) %>
  <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-medium text-gray-900">Asignar a Cuota</h3>
      <span class="text-xs font-medium text-[#125282] bg-blue-50 px-2.5 py-1 rounded-full">
        Total pendiente: L. <%= number_with_delimiter(total_pending, delimiter: ',') %>
      </span>
    </div>
    <p class="text-xs text-gray-600 mb-4">Selecciona la cuota inicial. Si el monto del pago es mayor, el excedente se aplicará automáticamente a las cuotas siguientes.</p>

    <div class="space-y-2 max-h-60 overflow-y-auto">
      <% installments.each do |installment| %>
        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-[#125282] transition-colors">
          <div class="flex items-center gap-3">
            <input type="radio"
                   name="installment_allocations[<%= installment.id %>]"
                   value="<%= installment.remaining_amount %>"
                   data-installment-id="<%= installment.id %>"
                   data-amount="<%= installment.remaining_amount %>"
                   class="installment-radio h-4 w-4 text-[#125282] border-gray-300 focus:ring-[#125282]"
                   onclick="selectInstallment(this)">
            <div>
              <span class="font-medium text-gray-900">Cuota #<%= installment.installment_number %></span>
              <span class="text-xs text-gray-500 ml-2">Vence: <%= installment.due_date.strftime("%d/%m/%Y") %></span>
              <% if installment.overdue? %>
                <span class="text-xs text-red-600 ml-2">(Vencida - <%= installment.days_overdue %> días)</span>
              <% end %>
            </div>
          </div>
          <div class="text-right">
            <span class="font-semibold text-gray-900">L. <%= number_with_delimiter(installment.remaining_amount, delimiter: ',') %></span>
            <% if installment.paid_amount.to_f > 0 %>
              <span class="block text-xs text-green-600">Abonado: L. <%= number_with_delimiter(installment.paid_amount, delimiter: ',') %></span>
            <% end %>
          </div>
        </label>
      <% end %>
    </div>
  </div>

  <script>
    function selectInstallment(radio) {
      // Clear all other radio buttons in other installments
      document.querySelectorAll('.installment-radio').forEach(r => {
        if (r !== radio) {
          r.checked = false;
          r.name = 'installment_allocations[' + r.dataset.installmentId + ']';
        }
      });

      // Set the amount field to match the installment amount
      const amountField = document.getElementById('payment_amount');
      if (amountField && radio.dataset.amount) {
        amountField.value = radio.dataset.amount;
      }
    }
  </script>
<% else %>
  <% if loan.present? %>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
      <p class="text-sm text-green-800">Este préstamo no tiene cuotas pendientes.</p>
    </div>
  <% end %>
<% end %>
