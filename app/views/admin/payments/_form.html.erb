<%= form_with model: [:admin, @payment], local: true, class: "space-y-4 sm:space-y-6", multipart: true, data: { controller: "payment-form" } do |f| %>
  <% if @payment.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
      <h3 class="text-xs sm:text-sm font-medium text-red-800 mb-2">Se encontraron los siguientes errores:</h3>
      <ul class="list-disc pl-5 text-xs sm:text-sm text-red-700">
        <% @payment.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Loan Selection -->
  <div>
    <%= f.label :loan_id, "Préstamo", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= f.select :loan_id, @loans, { prompt: "Selecciona un préstamo" }, class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]", required: true, data: { payment_form_target: "loanSelect", action: "change->payment-form#loadInstallments" } %>
    <p class="text-xs sm:text-sm text-gray-600 mt-2">Selecciona el préstamo al cual se aplicará este pago.</p>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <!-- Amount -->
    <div>
      <%= f.label :amount, "Monto (L.)", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.number_field :amount, step: 0.01, min: 0, placeholder: "Ej: 1500.00", class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]", required: true %>
    </div>

    <!-- Payment Date -->
    <div>
      <%= f.label :payment_date, "Fecha del Pago", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.date_field :payment_date, value: @payment.payment_date || Date.current, class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]", required: true %>
    </div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <!-- Payment Method -->
    <div>
      <%= f.label :payment_method, "Método de Pago", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.select :payment_method, [["Efectivo", "cash"], ["Transferencia", "transfer"], ["Tarjeta", "card"], ["Otro", "other"]], { prompt: "Selecciona método" }, class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]", required: true %>
    </div>

    <!-- Bank Source -->
    <div>
      <%= f.label :bank_source, "Banco / Fuente", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.select :bank_source, @bank_sources, { include_blank: "Seleccionar (Opcional)" }, class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]" %>
    </div>
  </div>

  <!-- Reference Number -->
  <div>
    <%= f.label :reference_number, "Número de Referencia", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= f.text_field :reference_number, placeholder: "Ej: TRX-123456 (Opcional)", class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]" %>
    <p class="text-xs sm:text-sm text-gray-600 mt-2">Referencia de la transacción bancaria o Tigo Money.</p>
  </div>

  <!-- Notes -->
  <div>
    <%= f.label :notes, "Notas", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= f.text_area :notes, rows: 3, placeholder: "Notas adicionales sobre el pago (Opcional)", class: "mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]" %>
  </div>

  <!-- Installment Selection (dynamic or pre-loaded) -->
  <div data-payment-form-target="installmentsContainer">
    <% if defined?(@installments) && @installments.present? %>
      <%= render partial: "installments_section", locals: { installments: @installments, loan: @loan } %>
    <% end %>
  </div>

  <!-- Verification Image -->
  <div>
    <%= f.label :verification_image, "Imagen de Verificación (Opcional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <% if @payment.verification_image.attached? %>
      <div class="mb-3 p-3 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600 mb-2">Imagen actual:</p>
        <%= image_tag @payment.verification_image, class: "max-w-xs rounded-lg border" %>
      </div>
    <% end %>
    <label for="payment_verification_image" id="verification-image-label" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
      <div id="verification-image-placeholder" class="flex flex-col items-center justify-center pt-5 pb-6">
        <svg class="w-8 h-8 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="mb-1 text-sm text-gray-500"><span class="font-semibold text-[#125282]">Clic para subir</span> o arrastra aquí</p>
        <p class="text-xs text-gray-400">Formatos: PNG, JPG, JPEG</p>
      </div>
      <div id="verification-image-preview" class="hidden flex flex-col items-center justify-center pt-5 pb-6">
        <svg class="w-8 h-8 mb-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="mb-1 text-sm text-green-600 font-medium" id="verification-image-name">Archivo seleccionado</p>
        <p class="text-xs text-gray-400">Clic para cambiar</p>
      </div>
    </label>
    <%= f.file_field :verification_image, accept: "image/*", id: "payment_verification_image", class: "sr-only", onchange: "showSelectedFile(this)" %>
    <p class="text-xs text-gray-500 mt-2">Comprobante de pago, captura de transferencia o recibo.</p>
  </div>

  <script>
    function showSelectedFile(input) {
      const placeholder = document.getElementById('verification-image-placeholder');
      const preview = document.getElementById('verification-image-preview');
      const fileName = document.getElementById('verification-image-name');
      const label = document.getElementById('verification-image-label');

      if (input.files && input.files[0]) {
        placeholder.classList.add('hidden');
        preview.classList.remove('hidden');
        fileName.textContent = input.files[0].name;
        label.classList.remove('border-gray-300');
        label.classList.add('border-green-500', 'bg-green-50');
      } else {
        placeholder.classList.remove('hidden');
        preview.classList.add('hidden');
        label.classList.add('border-gray-300');
        label.classList.remove('border-green-500', 'bg-green-50');
      }
    }
  </script>

  <% if @payment.new_record? %>
    <!-- Auto-verify checkbox for new payments created by Admin/Supervisor -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <label class="flex items-start gap-3 cursor-pointer">
        <input type="checkbox" name="auto_verify" value="1" checked class="mt-1 h-4 w-4 text-[#125282] border-gray-300 rounded focus:ring-[#125282]">
        <div>
          <span class="block text-sm font-medium text-blue-900">Verificar automáticamente</span>
          <span class="text-xs text-blue-700">Al marcar esta opción, el pago se guardará como verificado inmediatamente.</span>
        </div>
      </label>
    </div>
  <% end %>

  <!-- Submit button -->
  <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 pt-4 sm:pt-6 border-t">
    <%= f.submit @payment.new_record? ? "Registrar Pago" : "Actualizar Pago", class: "bg-[#125282] hover:bg-[#0f4670] text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-colors text-sm sm:text-base text-center cursor-pointer" %>
    <% cancel_path = @loan.present? ? vendor_loan_path(@loan) : admin_payments_path %>
    <%= link_to "Cancelar", cancel_path, class: "bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-colors text-sm sm:text-base text-center" %>
  </div>
<% end %>
