<% content_for :title, "Monitoreo de Jobs - MOVICUOTAS" %>

<div class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4 py-8">
  <!-- Page header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-[#125282]">üìä Monitoreo de Jobs</h1>
    <p class="text-gray-600 mt-2">Estado y gesti√≥n de tareas en segundo plano</p>
  </div>

  <!-- Metrics grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Jobs Hoy -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-[#125282] mb-2">üìã Total Hoy</h3>
      <p class="text-3xl font-bold text-gray-800"><%= @total_jobs_today %></p>
      <p class="text-sm text-gray-600 mt-2">Jobs encolados en las √∫ltimas 24 horas</p>
    </div>

    <!-- Completed Jobs -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-green-600 mb-2">‚úÖ Completados</h3>
      <p class="text-3xl font-bold text-green-700"><%= @completed_jobs %></p>
      <p class="text-sm text-gray-600 mt-2">Hoy</p>
    </div>

    <!-- Failed Jobs -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-red-600 mb-2">‚ùå Fallidos</h3>
      <p class="text-3xl font-bold text-red-700"><%= @failed_jobs %></p>
      <p class="text-sm text-gray-600 mt-2">
        <%= link_to "Ver detalles", admin_jobs_path(status: 'failed'), class: "text-[#125282] hover:underline font-medium" %>
      </p>
    </div>

    <!-- Running Jobs -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-blue-600 mb-2">üîÑ En Ejecuci√≥n</h3>
      <p class="text-3xl font-bold text-blue-700"><%= @running_jobs %></p>
      <p class="text-sm text-gray-600 mt-2">En este momento</p>
    </div>
  </div>

  <!-- Secondary metrics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Pending Jobs -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-yellow-600 mb-2">‚è≥ Pendientes</h3>
      <p class="text-2xl font-bold text-yellow-700"><%= @pending_jobs %></p>
    </div>

    <!-- Scheduled Jobs -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-purple-600 mb-2">üìÖ Programados</h3>
      <p class="text-2xl font-bold text-purple-700"><%= @scheduled_jobs %></p>
    </div>

    <!-- Queue Health -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-[#125282] mb-2">üîå Colas Activas</h3>
      <p class="text-2xl font-bold text-[#125282]"><%= @queues.count %></p>
    </div>
  </div>

  <!-- Manual Job Triggers -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-8">
    <h3 class="text-lg font-semibold text-[#125282] mb-2">‚ö° Ejecutar Jobs Manualmente</h3>
    <p class="text-sm text-gray-600 mb-6">Encolar jobs para ejecuci√≥n inmediata. Cada bot√≥n ejecuta una tarea espec√≠fica.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- 1. Mark Installments Overdue -->
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <h4 class="font-medium text-gray-900 mb-2">üìã Marcar Cuotas Vencidas</h4>
        <p class="text-xs text-gray-600 mb-3">Identifica todas las cuotas con fecha de vencimiento pasada y las marca como vencidas.</p>
        <%= form_with url: trigger_admin_jobs_path, method: :post, local: true do |f| %>
          <%= f.hidden_field :job_class, value: "MarkInstallmentsOverdueJob" %>
          <%= f.submit "Ejecutar Ahora",
              class: "bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded font-medium transition-colors w-full text-sm",
              data: { confirm: "¬øEjecutar ahora? Esto marcar√° todas las cuotas vencidas." } %>
        <% end %>
      </div>

      <!-- 2. Send Overdue Notifications -->
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <h4 class="font-medium text-gray-900 mb-2">üì¢ Enviar Notificaciones de Mora</h4>
        <p class="text-xs text-gray-600 mb-3">Env√≠a notificaciones a clientes en mora (1, 7, 14, 30+ d√≠as). Respeta preferencias de notificaci√≥n.</p>
        <%= form_with url: trigger_admin_jobs_path, method: :post, local: true do |f| %>
          <%= f.hidden_field :job_class, value: "SendOverdueNotificationJob" %>
          <%= f.submit "Ejecutar Ahora",
              class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition-colors w-full text-sm",
              data: { confirm: "¬øEjecutar ahora? Enviar√° notificaciones a clientes con mora." } %>
        <% end %>
      </div>

      <!-- 3. Send Late Payment Warnings -->
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <h4 class="font-medium text-gray-900 mb-2">‚ö†Ô∏è Enviar Advertencias de Mora</h4>
        <p class="text-xs text-gray-600 mb-3">Env√≠a advertencias escaladas de mora (3, 7, 14, 27 d√≠as). M√°s agresivo que notificaciones.</p>
        <%= form_with url: trigger_admin_jobs_path, method: :post, local: true do |f| %>
          <%= f.hidden_field :job_class, value: "SendLatePaymentWarningJob" %>
          <%= f.submit "Ejecutar Ahora",
              class: "bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-medium transition-colors w-full text-sm",
              data: { confirm: "¬øEjecutar ahora? Enviar√° advertencias de mora a clientes." } %>
        <% end %>
      </div>

      <!-- 4. Notify Cobradores -->
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <h4 class="font-medium text-gray-900 mb-2">üìä Reporte Diario para Cobradores</h4>
        <p class="text-xs text-gray-600 mb-3">Env√≠a reporte de mora a todos los cobradores con estad√≠sticas y dispositivos bloqueados.</p>
        <%= form_with url: trigger_admin_jobs_path, method: :post, local: true do |f| %>
          <%= f.hidden_field :job_class, value: "NotifyCobradoresJob" %>
          <%= f.submit "Ejecutar Ahora",
              class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors w-full text-sm",
              data: { confirm: "¬øEjecutar ahora? Enviar√° reporte a los cobradores." } %>
        <% end %>
      </div>

      <!-- 5. Auto Block Device -->
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <h4 class="font-medium text-gray-900 mb-2">üîí Auto-Bloquear Dispositivos</h4>
        <p class="text-xs text-gray-600 mb-3">Bloquea autom√°ticamente dispositivos con 30+ d√≠as en mora. Usa servicio MDM.</p>
        <%= form_with url: trigger_admin_jobs_path, method: :post, local: true do |f| %>
          <%= f.hidden_field :job_class, value: "AutoBlockDeviceJob" %>
          <%= f.submit "Ejecutar Ahora",
              class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium transition-colors w-full text-sm",
              data: { confirm: "‚ö†Ô∏è ACCI√ìN CR√çTICA: Esto bloquear√° dispositivos con 30+ d√≠as en mora. ¬øContinuar?" } %>
        <% end %>
      </div>
    </div>

    <p class="text-xs text-gray-500 mt-6 p-3 bg-gray-50 rounded border border-gray-200">
      <strong>‚ÑπÔ∏è C√≥mo funciona:</strong> Al hacer clic en "Ejecutar Ahora", el job se encola inmediatamente. Se ejecutar√° seg√∫n la disponibilidad de workers (generalmente en segundos). Puedes ver el estado en la tabla de jobs abajo.
    </p>
  </div>

  <!-- Filter and search section -->
  <div id="filters-section" class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-8">
    <h3 class="text-lg font-semibold text-[#125282] mb-4">Filtros y B√∫squeda</h3>

    <%= form_with url: admin_jobs_path, method: :get, local: true, class: "space-y-4" do |f| %>
      <!-- Status filters -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-3">Estado</label>
        <div class="flex flex-wrap gap-4 mb-6">
          <%= link_to "Todos", admin_jobs_path(anchor: 'filters-section'),
              class: "#{params[:status].blank? ? 'bg-[#125282] text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap" %>
          <%= link_to "Pendientes", admin_jobs_path(status: 'pending', anchor: 'filters-section'),
              class: "#{params[:status] == 'pending' ? 'bg-[#125282] text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap" %>
          <%= link_to "En Ejecuci√≥n", admin_jobs_path(status: 'running', anchor: 'filters-section'),
              class: "#{params[:status] == 'running' ? 'bg-[#125282] text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap" %>
          <%= link_to "Completados", admin_jobs_path(status: 'completed', anchor: 'filters-section'),
              class: "#{params[:status] == 'completed' ? 'bg-[#125282] text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap" %>
          <%= link_to "Fallidos", admin_jobs_path(status: 'failed', anchor: 'filters-section'),
              class: "#{params[:status] == 'failed' ? 'bg-[#125282] text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap" %>
          <%= link_to "Programados", admin_jobs_path(status: 'scheduled', anchor: 'filters-section'),
              class: "#{params[:status] == 'scheduled' ? 'bg-[#125282] text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap" %>
        </div>
      </div>

      <!-- Search and dropdowns -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Search field -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">B√∫squeda</label>
          <%= f.search_field :search, placeholder: "Buscar por ID o clase de job",
              value: params[:search],
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]" %>
        </div>

        <!-- Queue filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Cola</label>
          <%= f.select :queue, [["Todas las colas", ""]] + @queues.map { |q| [q, q] },
              { selected: params[:queue] },
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]" %>
        </div>

        <!-- Job class filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Job</label>
          <%= f.select :job_class, [["Todos los jobs", ""]] + @job_classes.map { |c| [c, c] },
              { selected: params[:job_class] },
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#125282] focus:border-[#125282]" %>
        </div>
      </div>

      <!-- Search button -->
      <div>
        <%= f.submit "Buscar", class: "bg-[#125282] hover:bg-[#0f4670] text-white px-6 py-2 rounded-lg font-medium transition-colors", data: { "turbo-action": "replace" } %>
      </div>
    <% end %>

    <script>
      // Keep focus on filters section when filtering
      document.querySelector('form').addEventListener('submit', function() {
        setTimeout(() => {
          const filtersSection = document.getElementById('filters-section');
          if (filtersSection) {
            filtersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      });
    </script>
  </div>

  <!-- Jobs table -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Class</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cola</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creado</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finalizado</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% if @jobs.records.any? %>
            <% @jobs.records.each do |job| %>
              <% status = determine_job_status(job) %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  <%= link_to job.id, admin_job_path(job), class: "text-[#125282] hover:underline" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  <%= job.class_name %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800">
                    <%= job.queue_name %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <% case status %>
                  <% when 'completed' %>
                    <span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-800">‚úì Completado</span>
                  <% when 'failed' %>
                    <span class="px-3 py-1 text-sm rounded-full bg-red-100 text-red-800">‚úï Fallido</span>
                  <% when 'running' %>
                    <span class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800">‚óè En ejecuci√≥n</span>
                  <% when 'pending' %>
                    <span class="px-3 py-1 text-sm rounded-full bg-orange-100 text-orange-800">‚è≥ Pendiente</span>
                  <% when 'scheduled' %>
                    <span class="px-3 py-1 text-sm rounded-full bg-indigo-100 text-indigo-800">üìÖ Programado</span>
                  <% else %>
                    <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800"><%= status %></span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  <%= job.created_at.strftime("%d/%m/%Y %H:%M") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  <% if job.finished_at %>
                    <%= job.finished_at.strftime("%d/%m/%Y %H:%M") %>
                  <% else %>
                    <span class="text-gray-400">-</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                  <%= link_to "Ver", admin_job_path(job), class: "text-[#125282] hover:underline font-medium" %>
                  <% if status == 'failed' %>
                    <%= link_to "Reintentar", admin_job_retry_path(job),
                        data: { turbo_method: :post, confirm: "¬øReintentar este job?" },
                        class: "text-orange-600 hover:underline font-medium" %>
                  <% elsif ['pending', 'scheduled'].include?(status) %>
                    <%= link_to "Cancelar", cancel_admin_job_path(job),
                        data: { turbo_method: :post, confirm: "¬øCancelar este job?" },
                        class: "text-red-600 hover:underline font-medium" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                No hay jobs que coincidan con tu b√∫squeda
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Pagination footer -->
    <% if @jobs.records.any? %>
      <div class="bg-white px-6 py-4 border-t border-gray-200 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          Mostrando <strong><%= @jobs.offset_value + 1 %></strong> a
          <strong><%= [@jobs.offset_value + @jobs.size, @jobs.total_count].min %></strong> de
          <strong><%= @jobs.total_count %></strong> jobs
        </div>
        <div class="flex gap-2">
          <!-- Previous page -->
          <% if @jobs.current_page > 1 %>
            <%= link_to "‚Üê Anterior", admin_jobs_path(params.merge(page: @jobs.current_page - 1, anchor: 'filters-section')),
                class: "px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 font-medium" %>
          <% end %>

          <!-- Page numbers -->
          <% (1..@jobs.total_pages).each do |page_num| %>
            <% if page_num == @jobs.current_page %>
              <span class="px-4 py-2 bg-[#125282] text-white rounded-lg font-medium"><%= page_num %></span>
            <% elsif (page_num - @jobs.current_page).abs <= 2 %>
              <%= link_to page_num, admin_jobs_path(params.merge(page: page_num, anchor: 'filters-section')),
                  class: "px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 font-medium" %>
            <% elsif page_num == 1 || page_num == @jobs.total_pages %>
              <%= link_to page_num, admin_jobs_path(params.merge(page: page_num, anchor: 'filters-section')),
                  class: "px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 font-medium" %>
            <% elsif (page_num == 2 && @jobs.current_page > 3) || (page_num == @jobs.total_pages - 1 && @jobs.current_page < @jobs.total_pages - 2) %>
              <span class="px-4 py-2 text-gray-500">...</span>
            <% end %>
          <% end %>

          <!-- Next page -->
          <% if @jobs.current_page < @jobs.total_pages %>
            <%= link_to "Siguiente ‚Üí", admin_jobs_path(params.merge(page: @jobs.current_page + 1, anchor: 'filters-section')),
                class: "px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 font-medium" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Footer navigation -->
  <div class="mt-8 pt-8 border-t border-gray-200">
    <%= link_to "‚Üê Volver al Dashboard", admin_dashboard_path,
        class: "text-[#125282] hover:underline font-medium" %>
  </div>
</div>
