<% content_for :title, "Detalle del Job - MOVICUOTAS" %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page header -->
  <div class="mb-8 flex justify-between items-start">
    <div>
      <h1 class="text-3xl font-bold text-[#125282]"><%= @job.class_name %></h1>
      <p class="text-gray-600 mt-2">ID: <%= @job.id %></p>
    </div>
    <div>
      <% case @job_status %>
      <% when 'completed' %>
        <span class="px-4 py-2 text-lg rounded-full bg-green-100 text-green-800 font-medium">‚úì Completado</span>
      <% when 'failed' %>
        <span class="px-4 py-2 text-lg rounded-full bg-red-100 text-red-800 font-medium">‚úï Fallido</span>
      <% when 'running' %>
        <span class="px-4 py-2 text-lg rounded-full bg-blue-100 text-blue-800 font-medium">‚óè En ejecuci√≥n</span>
      <% when 'pending' %>
        <span class="px-4 py-2 text-lg rounded-full bg-yellow-100 text-yellow-800 font-medium">‚è≥ Pendiente</span>
      <% when 'scheduled' %>
        <span class="px-4 py-2 text-lg rounded-full bg-purple-100 text-purple-800 font-medium">üìÖ Programado</span>
      <% else %>
        <span class="px-4 py-2 text-lg rounded-full bg-gray-100 text-gray-800 font-medium"><%= @job_status %></span>
      <% end %>
    </div>
  </div>

  <!-- Job Details Grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Informaci√≥n del Job -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-[#125282] mb-6">‚ÑπÔ∏è Informaci√≥n del Job</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-600">ID del Job</label>
          <p class="text-lg text-gray-900 mt-1"><%= @job.id %></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">Clase del Job</label>
          <p class="text-lg text-gray-900 mt-1"><%= @job.class_name %></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">Cola</label>
          <p class="text-lg text-gray-900 mt-1">
            <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800">
              <%= @job.queue_name %>
            </span>
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">Prioridad</label>
          <p class="text-lg text-gray-900 mt-1"><%= @job.priority %></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">ActiveJob ID</label>
          <p class="text-sm text-gray-900 mt-1 break-all"><code><%= @job.active_job_id %></code></p>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de Ejecuci√≥n -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-[#125282] mb-6">‚è±Ô∏è Informaci√≥n de Ejecuci√≥n</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-600">Creado</label>
          <p class="text-lg text-gray-900 mt-1">
            <%= @job.created_at.strftime("%d/%m/%Y %H:%M:%S") %>
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">Programado Para</label>
          <p class="text-lg text-gray-900 mt-1">
            <% if @job.scheduled_at %>
              <%= @job.scheduled_at.strftime("%d/%m/%Y %H:%M:%S") %>
            <% else %>
              <span class="text-gray-400">-</span>
            <% end %>
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">Finalizado</label>
          <p class="text-lg text-gray-900 mt-1">
            <% if @job.finished_at %>
              <%= @job.finished_at.strftime("%d/%m/%Y %H:%M:%S") %>
            <% else %>
              <span class="text-gray-400">-</span>
            <% end %>
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600">Duraci√≥n</label>
          <p class="text-lg text-gray-900 mt-1">
            <% if @job.finished_at && @job.created_at %>
              <% duration = (@job.finished_at - @job.created_at).round(2) %>
              <% if duration < 1 %>
                <%= (duration * 1000).round %>ms
              <% else %>
                <%= duration.round(2) %>s
              <% end %>
            <% else %>
              <span class="text-gray-400">-</span>
            <% end %>
          </p>
        </div>
      </div>
    </div>

    <!-- Argumentos -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-[#125282] mb-6">üìù Argumentos</h2>
      <div class="space-y-4">
        <div>
          <% if @job.arguments.present? %>
            <pre class="bg-gray-50 p-4 rounded text-sm overflow-x-auto text-gray-900"><%= JSON.pretty_generate(JSON.parse(@job.arguments)) rescue @job.arguments %></pre>
          <% else %>
            <p class="text-gray-400">Sin argumentos</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Error section (if failed) -->
  <% if @failed_execution %>
    <div class="bg-red-50 border border-red-200 rounded-xl shadow-md p-6 mb-8">
      <div class="flex justify-between items-start mb-6">
        <h2 class="text-xl font-semibold text-red-800">üö® Informaci√≥n de Error</h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Exception Class -->
        <div>
          <label class="block text-sm font-medium text-red-700 mb-2">Clase de Excepci√≥n</label>
          <p class="text-lg font-mono text-red-900 bg-white p-3 rounded border border-red-200">
            <%= @failed_execution.exception_class %>
          </p>
        </div>

        <!-- Error Message -->
        <div>
          <label class="block text-sm font-medium text-red-700 mb-2">Mensaje de Error</label>
          <p class="text-lg text-red-900 bg-white p-3 rounded border border-red-200">
            <%= @failed_execution.message %>
          </p>
        </div>
      </div>

      <!-- Backtrace -->
      <% if @failed_execution.backtrace.present? %>
        <div class="mb-6">
          <details class="bg-white border border-red-200 rounded-lg p-4">
            <summary class="cursor-pointer font-semibold text-red-800 hover:text-red-600">
              üìã Ver Backtrace (<%= @failed_execution.backtrace.count %> l√≠neas)
            </summary>
            <pre class="mt-4 bg-gray-50 p-4 rounded text-xs overflow-x-auto text-gray-900"><%= @failed_execution.backtrace.join("\n") %></pre>
          </details>
        </div>
      <% end %>

      <!-- Retry button -->
      <div class="flex gap-4">
        <%= link_to "üîÑ Reintentar Job", admin_job_retry_path(@job), method: :post,
            data: { confirm: "¬øEst√° seguro que desea reintentar este job?" },
            class: "bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium transition-colors" %>
        <%= link_to "‚Üê Volver a Jobs", admin_jobs_path,
            class: "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-3 rounded-lg font-medium transition-colors" %>
      </div>
    </div>
  <% else %>
    <!-- No error section -->
    <div class="mb-8">
      <% case @job_status %>
      <% when 'completed' %>
        <div class="bg-green-50 border border-green-200 rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-green-800 mb-4">‚úì Job Completado Exitosamente</h2>
          <p class="text-green-700">Este job se ejecut√≥ sin errores.</p>
        </div>
      <% when 'running' %>
        <div class="bg-blue-50 border border-blue-200 rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-blue-800 mb-4">‚óè Job en Ejecuci√≥n</h2>
          <p class="text-blue-700">Este job est√° siendo procesado en este momento.</p>
        </div>
      <% when 'pending' %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-yellow-800 mb-4">‚è≥ Job Pendiente</h2>
          <p class="text-yellow-700">Este job est√° esperando para ser procesado.</p>
        </div>
      <% when 'scheduled' %>
        <div class="bg-purple-50 border border-purple-200 rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-purple-800 mb-4">üìÖ Job Programado</h2>
          <p class="text-purple-700">Este job est√° programado para ejecutarse en una fecha futura.</p>
        </div>
      <% else %>
        <div class="bg-gray-50 border border-gray-200 rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">‚ÑπÔ∏è Job</h2>
          <p class="text-gray-700">Estado: <%= @job_status %></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Footer navigation -->
  <div class="mt-8 pt-8 border-t border-gray-200 flex justify-between items-center">
    <div>
      <%= link_to "‚Üê Volver a Monitoreo de Jobs", admin_jobs_path,
          class: "text-[#125282] hover:underline font-medium" %>
    </div>
    <div class="text-sm text-gray-500">
      √öltima actualizaci√≥n: <%= Time.current.strftime("%d/%m/%Y %H:%M:%S") %>
    </div>
  </div>
</div>
