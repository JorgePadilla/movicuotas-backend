<% content_for :title, "Detalles del Pr√©stamo - Admin - MOVICUOTAS" %>

<div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4">
  <%= render Admin::BreadcrumbComponent.new(items: [
    { name: "Pr√©stamos", path: admin_loans_path },
    { name: @loan.contract_number }
  ]) %>

  <!-- Page header -->
  <div class="mb-6 sm:mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 class="text-lg sm:text-2xl lg:text-3xl font-bold text-[#125282] break-all"><%= @loan.contract_number %></h1>
        <p class="text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base"><%= @loan.customer.full_name %> ‚Ä¢ Sucursal <%= @loan.branch_number %></p>
      </div>
      <div class="self-start sm:self-auto flex items-center gap-3">
        <span class="px-3 py-1 sm:px-4 sm:py-2 text-sm sm:text-lg rounded-lg font-medium <%= @loan.active? ? 'bg-green-100 text-green-800' : @loan.paid? ? 'bg-blue-100 text-blue-800' : @loan.overdue? ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800' %>">
          <%= loan_status_es(@loan.status) %>
        </span>
        <% if policy(@loan).cancel? %>
          <%= link_to "Cancelar Pr√©stamo", cancel_admin_loan_path(@loan), data: { turbo_method: :patch, turbo_confirm: "¬øEst√°s seguro de que deseas cancelar este pr√©stamo? El estado cambiar√° a 'Cancelado'." }, class: "bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm" %>
        <% end %>
        <% if current_user.master? %>
          <%= link_to "Eliminar Pr√©stamo", admin_loan_path(@loan), data: { turbo_method: :delete, turbo_confirm: "¬øEst√°s seguro de que deseas eliminar este pr√©stamo? Esta acci√≥n no se puede deshacer y eliminar√° todas las cuotas y pagos asociados." }, class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Loan details grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
    <!-- Customer Info -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-6">
      <h2 class="text-lg sm:text-xl font-semibold text-[#125282] mb-4 sm:mb-6">Cliente</h2>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Nombre</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.customer.full_name %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Identidad</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.customer.identification_number %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Tel√©fono</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.customer.phone %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Email</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1 break-all"><%= @loan.customer.email || "‚Äî" %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Edad</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.customer.age %> a√±os</p>
        </div>
      </div>
    </div>

    <!-- Loan Amounts -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-6">
      <h2 class="text-lg sm:text-xl font-semibold text-[#125282] mb-4 sm:mb-6">Montos</h2>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Monto Total</label>
          <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1">L. <%= number_with_delimiter(@loan.total_amount, delimiter: ',') %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Prima (<%= @loan.down_payment_percentage %>%)</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1">L. <%= number_with_delimiter(@loan.down_payment_amount, delimiter: ',') %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Monto Financiado</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1">L. <%= number_with_delimiter(@loan.financed_amount, delimiter: ',') %></p>
        </div>
        <div class="border-t pt-3 sm:pt-4">
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Total Pagado</label>
          <p class="text-base sm:text-lg font-semibold text-green-600 mt-1">L. <%= number_with_delimiter(@loan.total_paid, delimiter: ',') %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Balance Pendiente</label>
          <p class="text-base sm:text-lg font-semibold <%= @loan.remaining_balance > 0 ? 'text-red-600' : 'text-green-600' %> mt-1">
            L. <%= number_with_delimiter(@loan.remaining_balance, delimiter: ',') %>
          </p>
        </div>
      </div>
    </div>

    <!-- Loan Details -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-6">
      <h2 class="text-lg sm:text-xl font-semibold text-[#125282] mb-4 sm:mb-6">Detalles</h2>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Tasa de Inter√©s (Quincenal)</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= (@loan.interest_rate * 100).round(2) %>%</p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Cuotas</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.number_of_installments %> quincenales</p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Fecha de Inicio</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.start_date.strftime("%d/%m/%Y") %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Creado por</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.user.full_name %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Sucursal</label>
          <p class="text-base sm:text-lg text-gray-900 mt-1"><%= @loan.branch_number %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Device Info (if assigned) -->
  <% if @loan.device %>
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-6 mb-6 sm:mb-8">
      <h2 class="text-lg sm:text-xl font-semibold text-[#125282] mb-4 sm:mb-6">Dispositivo Asignado</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Marca y Modelo</label>
          <p class="text-sm sm:text-lg text-gray-900 mt-1"><%= @loan.device.brand %> <%= @loan.device.model %></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">IMEI</label>
          <p class="text-xs sm:text-lg text-gray-900 mt-1 break-all"><code><%= @loan.device.imei %></code></p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Estado MDM</label>
          <p class="text-sm sm:text-lg text-gray-900 mt-1">
            <% if @loan.device.locked? %>
              <span class="px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs sm:text-sm font-medium">‚úì Bloqueado</span>
            <% elsif @loan.device.pending? %>
              <span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs sm:text-sm font-medium">‚è≥ Pendiente</span>
            <% else %>
              <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs sm:text-sm font-medium">üîì No bloqueado</span>
            <% end %>
          </p>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-600">Color</label>
          <p class="text-sm sm:text-lg text-gray-900 mt-1"><%= @loan.device.color || "‚Äî" %></p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Installments Schedule -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-6 mb-6 sm:mb-8">
    <h2 class="text-lg sm:text-xl font-semibold text-[#125282] mb-4 sm:mb-6">Cronograma de Cuotas</h2>

    <% if @loan.installments.any? %>
      <!-- Mobile Card View -->
      <div class="block sm:hidden space-y-3">
        <% @loan.installments.order(:due_date).each_with_index do |installment, index| %>
          <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
            <div class="flex justify-between items-start mb-2">
              <span class="font-bold text-gray-900">Cuota #<%= index + 1 %></span>
              <span class="px-2 py-1 text-xs rounded-full <%= installment.paid? ? 'bg-green-100 text-green-800' : installment.overdue? ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' %>">
                <%= installment_status_es(installment.status) %>
              </span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>
                <span class="text-gray-500 text-xs">Vencimiento</span>
                <p class="text-gray-900"><%= installment.due_date.strftime("%d/%m/%Y") %></p>
              </div>
              <div>
                <span class="text-gray-500 text-xs">Monto</span>
                <p class="text-gray-900">L. <%= number_with_delimiter(installment.amount, delimiter: ',') %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Desktop Table View -->
      <div class="hidden sm:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cuota</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimiento</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pagado</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @loan.installments.order(:due_date).each_with_index do |installment, index| %>
              <tr>
                <td class="px-4 py-3">
                  <span class="font-medium text-gray-900">#<%= index + 1 %></span>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm text-gray-600"><%= installment.due_date.strftime("%d/%m/%Y") %></span>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm font-medium text-gray-900">L. <%= number_with_delimiter(installment.amount, delimiter: ',') %></span>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm text-gray-600">
                    <% payment = @loan.payments.find { |p| p.installments.include?(installment) } %>
                    <% if payment %>
                      L. <%= number_with_delimiter(payment.amount, delimiter: ',') %>
                    <% else %>
                      L. 0.00
                    <% end %>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 text-xs rounded-full <%= installment.paid? ? 'bg-green-100 text-green-800' : installment.overdue? ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' %>">
                    <%= installment_status_es(installment.status) %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-gray-500 text-center py-6 sm:py-8 text-sm sm:text-base">No hay cuotas registradas</p>
    <% end %>
  </div>

  <!-- Payment History -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-6 mb-6 sm:mb-8">
    <h2 class="text-lg sm:text-xl font-semibold text-[#125282] mb-4 sm:mb-6">Historial de Pagos</h2>

    <% if @loan.payments.any? %>
      <!-- Mobile Card View -->
      <div class="block sm:hidden space-y-3">
        <% @loan.payments.order(payment_date: :desc).each do |payment| %>
          <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
            <div class="flex justify-between items-start mb-2">
              <span class="font-bold text-green-600">L. <%= number_with_delimiter(payment.amount, delimiter: ',') %></span>
              <span class="text-sm text-gray-600"><%= payment.payment_date.strftime("%d/%m/%Y") %></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600"><%= payment_method_es(payment.payment_method) %></span>
              <span class="text-gray-500 text-xs"><%= payment.reference_number || "‚Äî" %></span>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Desktop Table View -->
      <div class="hidden sm:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√©todo</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Referencia</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @loan.payments.order(payment_date: :desc).each do |payment| %>
              <tr>
                <td class="px-4 py-3">
                  <span class="text-sm font-medium text-gray-900"><%= payment.payment_date.strftime("%d/%m/%Y") %></span>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm font-medium text-green-600">L. <%= number_with_delimiter(payment.amount, delimiter: ',') %></span>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm text-gray-600"><%= payment_method_es(payment.payment_method) %></span>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm text-gray-600"><%= payment.reference_number || "‚Äî" %></span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-gray-500 text-center py-6 sm:py-8 text-sm sm:text-base">No hay pagos registrados</p>
    <% end %>
  </div>

</div>
