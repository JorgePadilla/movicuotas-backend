<% content_for :title, "Calculadora de Pagos - MOVICUOTAS" %>

<div class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4 py-4">
  <h1 class="text-3xl font-bold text-[#125282] mb-2">Calculadora de Pagos</h1>
  <p class="text-gray-600 mb-8">Paso 12: Calcula las cuotas quincenales para el crédito.</p>

  <%# Phone Price Summary %>
  <div class="bg-white shadow rounded-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Resumen del Teléfono</h2>
    <div>
      <p class="text-sm font-medium text-gray-500">Precio del Teléfono</p>
      <p class="text-2xl font-bold text-[#125282]">L. <%= number_with_delimiter(@phone_price.round(2), delimiter: ",") %></p>
    </div>
  </div>

  <%# Calculator Form %>
  <div class="bg-white shadow rounded-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">Configuración de Pago</h2>

    <%= form_with url: calculate_vendor_payment_calculator_path,
                  method: :post,
                  data: {
                    controller: "payment-calculator",
                    "payment-calculator-calculate-url-value": calculate_vendor_payment_calculator_path
                  },
                  class: "space-y-8" do |f| %>

      <%# Hidden fields for phone price and approved amount %>
      <%= hidden_field_tag :phone_price, @phone_price %>
      <%= hidden_field_tag :approved_amount, @approved_amount %>
      <%= hidden_field_tag :date_of_birth, @date_of_birth %>

      <%# Down Payment Selection %>
      <%# Calculate customer age to determine available options %>
      <%
        customer_age = nil
        if @date_of_birth.present?
          dob = @date_of_birth.is_a?(Date) ? @date_of_birth : Date.parse(@date_of_birth.to_s) rescue nil
          if dob
            today = Date.today
            customer_age = today.year - dob.year
            customer_age -= 1 if today.yday < dob.yday
          end
        end
        # 50-60 years: only 40% and 50% options
        # 21-49 years: all options (30%, 40%, 50%)
        is_senior_customer = customer_age && customer_age >= 50 && customer_age <= 60
        available_percentages = is_senior_customer ? [40, 50] : [30, 40, 50]
        grid_cols = is_senior_customer ? "md:grid-cols-2" : "md:grid-cols-3"
      %>
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-4">Pago Inicial</h3>
        <p class="text-sm text-gray-600 mb-4">Selecciona el porcentaje de pago inicial. Mayor pago inicial significa cuotas más bajas.</p>

        <div class="grid grid-cols-1 <%= grid_cols %> gap-4">
          <% available_percentages.each do |percentage| %>
            <label class="relative">
              <input
                type="radio"
                name="down_payment_percentage"
                value="<%= percentage %>"
                class="sr-only peer"
                <%= "checked" if @down_payment_percentage == percentage || (is_senior_customer && percentage == 40 && !available_percentages.include?(@down_payment_percentage)) %>
                data-action="change->payment-calculator#calculate"
              >
              <div class="cursor-pointer p-6 border-2 border-gray-200 rounded-lg hover:border-[#125282] peer-checked:border-[#125282] peer-checked:bg-blue-50 transition-all duration-200">
                <div class="text-center">
                  <p class="text-3xl font-bold text-[#125282]"><%= percentage %>%</p>
                  <p class="text-sm text-gray-600 mt-2">
                    <% down_payment = @phone_price * (percentage / 100.0) %>
                    L. <%= number_with_delimiter(down_payment.round(2), delimiter: ",") %>
                  </p>
                </div>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <%# Installment Term Selection %>
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-4">Plazo de Cuotas</h3>
        <p class="text-sm text-gray-600 mb-4">Selecciona el número de cuotas quincenales (cada 15 días).</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <% [6, 8, 12].each do |term| %>
            <label class="relative">
              <input
                type="radio"
                name="number_of_installments"
                value="<%= term %>"
                class="sr-only peer"
                <%= "checked" if @number_of_installments == term %>
                data-action="change->payment-calculator#calculate"
              >
              <div class="cursor-pointer p-6 border-2 border-gray-200 rounded-lg hover:border-[#125282] peer-checked:border-[#125282] peer-checked:bg-blue-50 transition-all duration-200">
                <div class="text-center">
                  <p class="text-3xl font-bold text-[#125282]"><%= term %></p>
                  <p class="text-sm text-gray-600 mt-2">
                    <% months = (term * 14) / 30.0 %>
                    ≈ <%= months.round(1) %> meses
                  </p>
                </div>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <%# Error Display %>
      <div id="calculator_errors">
        <% if @result && !@result[:success] %>
          <%= render partial: "vendor/payment_calculators/errors", locals: { errors: @result[:errors] } %>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Results Display (updated via Turbo Stream) %>
  <div id="calculator_results">
    <% if @result && @result[:success] %>
      <%= render partial: "vendor/payment_calculators/results", locals: { result: @result } %>
    <% else %>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <p class="text-gray-600">Selecciona las opciones de pago para calcular tu cuota quincenal.</p>
      </div>
    <% end %>
  </div>

  <%# Navigation %>
  <div class="flex flex-col md:flex-row justify-between items-center mt-8 pt-8 border-t border-gray-200">
    <div>
      <% if @credit_application_id.present? %>
        <%= link_to "← Volver a selección de teléfono", vendor_device_selection_path(@credit_application_id), class: "text-[#125282] hover:text-[#0f4670] font-medium" %>
      <% else %>
        <%= link_to "← Volver a búsqueda de cliente", vendor_customer_search_path, class: "text-[#125282] hover:text-[#0f4670] font-medium" %>
      <% end %>
    </div>
    <div>
      <%# Continue form (hidden initially if result not successful) %>
      <% continue_form_class = "inline #{@result && @result[:success] ? '' : 'hidden'}" %>
      <%= form_with url: vendor_payment_calculator_path, method: :post, class: continue_form_class, id: "continue_to_contract_form" do |f| %>
        <%= hidden_field_tag :phone_price, @phone_price %>
        <%= hidden_field_tag :approved_amount, @approved_amount %>
        <%= hidden_field_tag :date_of_birth, @date_of_birth %>
        <%= hidden_field_tag :down_payment_percentage, @down_payment_percentage %>
        <%= hidden_field_tag :number_of_installments, @number_of_installments %>
        <%= hidden_field_tag :credit_application_id, @credit_application_id %>
        <button type="submit"
                class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600">
          Continuar al Contrato →
        </button>
      <% end %>

      <%# Disabled button (shown initially if result not successful) %>
      <button disabled id="disabled_continue_button" class="bg-gray-300 text-gray-500 font-semibold py-3 px-8 rounded-lg cursor-not-allowed <%= @result && @result[:success] ? 'hidden' : '' %>">
        Continuar al Contrato →
      </button>
    </div>
  </div>

  <div class="mt-8 text-center text-sm text-gray-500">
    <p>Recuerda: Las cuotas son <strong>quincenales</strong> (cada 15 días).</p>
  </div>
</div>