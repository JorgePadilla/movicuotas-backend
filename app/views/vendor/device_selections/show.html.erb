<%# Step 10: Catálogo Teléfonos (Device Selection) %>
<div class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4 py-4">
  <div class="mb-6 md:mb-8">
    <h1 class="text-2xl md:text-3xl font-bold text-[#125282]">Catálogo de Teléfonos</h1>
    <p class="mt-2 text-gray-600">
      Seleccione un teléfono para el cliente <span class="font-semibold"><%= @credit_application.customer.full_name %></span>
      (Solicitud: <%= @credit_application.application_number %>)
    </p>
    <p class="mt-1 text-sm text-gray-500">
      <span class="font-medium text-green-600">✓ Crédito aprobado</span> - El precio del teléfono seleccionado debe ser menor o igual al monto aprobado (validación automática).
    </p>
  </div>

  <% if @credit_application.errors.any? %>
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
      <h3 class="text-red-800 font-medium">Error al seleccionar teléfono:</h3>
      <ul class="mt-2 text-red-700 text-sm list-disc list-inside">
        <% @credit_application.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with model: @credit_application, url: vendor_device_selection_path(@credit_application), method: :patch, data: { turbo: false }, html: { novalidate: true } do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <% @phone_models.each do |phone| %>
        <label class="relative">
          <input type="radio" name="credit_application[selected_phone_model_id]" value="<%= phone.id %>"
                 class="peer sr-only"
                 data-phone-price="<%= phone.price %>"
                 <%= "checked" if @credit_application.selected_phone_model_id == phone.id %>
                 required>
          <div class="border-2 border-gray-200 rounded-xl p-5 cursor-pointer transition-all duration-200
                      peer-checked:border-[#6366f1] peer-checked:ring-2 peer-checked:ring-[#6366f1] peer-checked:bg-[#6366f1]/5
                      hover:border-gray-300 hover:shadow-md">
            <%# Product card in purple (#6366f1) per color palette %>
            <div class="flex items-start justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900"><%= phone.brand %> <%= phone.model %></h3>
                <p class="text-sm text-gray-600 mt-1"><%= phone.storage %></p>
              </div>
              <% if phone.image_url.present? %>
                <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                  <img src="<%= phone.image_url %>" alt="<%= phone.brand %>" class="max-w-full max-h-full object-contain">
                </div>
              <% end %>
            </div>
            <div class="mt-4">
              <div class="text-2xl font-bold text-[#1f2937]">L. <%= number_to_currency(phone.price, unit: "", delimiter: ",") %></div>
              <p class="text-sm text-gray-500 mt-1">Precio total (sin accesorios)</p>
            </div>
            <div class="mt-4 text-sm text-gray-700">
              <% if phone.price <= @credit_application.approved_amount %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ✓ Dentro del monto aprobado
                </span>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  ✗ Excede monto aprobado
                </span>
              <% end %>
            </div>
          </div>
        </label>
      <% end %>
    </div>

    <%# IMEI and Color fields (always visible - user must fill before submitting) %>
    <div id="device-details" class="bg-gray-50 border border-gray-200 rounded-xl p-6 mb-8">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Datos del dispositivo seleccionado</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div data-controller="imei-validation">
          <%= f.label :selected_imei, "Número IMEI (15 dígitos) *", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_field :selected_imei,
                placeholder: "Ej: 123456789012345",
                maxlength: 15,
                pattern: "\\d{15}",
                title: "Debe tener 15 dígitos numéricos",
                required: true,
                data: { imei_validation_target: "input", action: "input->imei-validation#validate" },
                class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#125282] focus:border-[#125282]" %>
          <p data-imei-validation-target="feedback" class="mt-1 text-sm text-gray-500">Ingrese el IMEI del dispositivo físico (15 dígitos). Campo obligatorio.</p>
        </div>
        <div>
          <%= f.label :selected_color, "Color del dispositivo *", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :selected_color,
                options_for_select([["Seleccionar color...", ""]] + CreditApplication::DEVICE_COLORS.map { |c| [c, c] }, @credit_application.selected_color),
                {},
                class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#125282] focus:border-[#125282]",
                required: true %>
          <p class="mt-1 text-sm text-gray-500">Seleccione el color del dispositivo.</p>
        </div>
      </div>
    </div>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 pt-6 border-t border-gray-200">
      <div class="order-2 md:order-1">
        <%= link_to "← Volver a búsqueda", vendor_customer_search_path, class: "text-sm text-[#125282] hover:underline py-2" %>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 order-1 md:order-2">
        <%= link_to "Cancelar", vendor_customer_search_path, class: "px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-center text-sm" %>
        <%= f.submit "Siguiente →", class: "px-6 py-2.5 bg-[#125282] text-white font-medium rounded-lg hover:bg-[#125282]/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#125282] cursor-pointer text-sm" %>
      </div>
    </div>
  <% end %>
</div>

